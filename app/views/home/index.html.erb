<h1 class="dashboard-title">ダッシュボード</h1>

<%# ----- 成長記録(ステータス) ----- %>
<div class="stats-grid">

  <%# 最新身長カード %>
  <div class="stat-card">
    <h3>最新身長</h3>
    <% if @latest_height %>
      <p class="stat-value"><%= @latest_height %> cm</p>
      <div class="stat-diff-container">
        <span class="stat-diff <%= @height_diff >= 0 ? 'up' : 'down' %>">
          <%= @height_diff >= 0 ? "+" : "" %><%= @height_diff %> cm
        </span>
      </div>
    <% else %>
      <p class="stat-value">なし</p>
    <% end %>
  </div>

  <%# 最新体重カード %>
  <div class="stat-card">
    <h3>最新体重</h3>
    <% if @latest_weight %>
      <p class="stat-value"><%= @latest_weight %> kg</p>
      <div class="stat-diff-container">
        <span class="stat-diff <%= @weight_diff >= 0 ? 'up' : 'down' %>">
        <%= @weight_diff >= 0 ? "+" : "" %><%= sprintf("%.1f", @weight_diff) %> kg
      </div>
      </span>
    <% else %>
      <p class="stat-value">なし</p>
    <% end %>
  </div>

  <%# 平均睡眠時間カード %>
  <div class="stat-card stat-sleep-card">
    <h3>平均睡眠時間</h3>
      <div class="stat-value-container">
        <% avg_day = @average_daytime_sleep.to_i %>
        <% avg_day_hours = avg_day / 60 %>
        <% avg_day_minutes = avg_day % 60 %>
        <% avg_night = @average_nighttime_sleep.to_i %>
        <% avg_night_hours = avg_night / 60 %>
        <% avg_night_minutes = avg_night % 60 %>
        <p class="stat-value">
          昼: <%= avg_day_hours %>時間<%= avg_day_minutes %>分 <span class="stat-divider">/</span>
        </p>
        <p class="stat-value">
          夜: <%= avg_night_hours %>時間<%= avg_night_minutes %>分
        </p>
      </div>

      <div class="stat-diff-container">
        <div class="stat-diff-group">
          <span class="stat-diff <%= @daytime_change >= 0 ? 'up' : 'down' %>">
            昼: <%= @daytime_change >= 0 ? '+' : '' %><%= @daytime_change %>分
          </span>
          <span class="stat-diff <%= @nighttime_change >= 0 ? 'up' : 'down' %>">
            夜: <%= @nighttime_change >= 0 ? '+' : '' %><%= @nighttime_change %>分
          </span>
        </div>
        <span class="stat-diff-label">（先週比）</span>
      </div>
  </div>

  <%# 今週の記録数カード（0でも表示） %>
  <div class="stat-card">
    <h3>今週の記録数</h3>
    <p class="stat-value stat-record-value">
      <%= @weekly_records_count || 0 %> 件
    </p>
  </div>

</div>

<%# スケジュール一覧部分を置き換え %>
<%= render partial: "home/schedules_table_or_empty", locals: { latest_schedules: @latest_schedules } %>

<%# ----- 育児記録一覧 ----- %>
<h2 class="dashboard-title">育児記録一覧</h2>

<div class="flex justify-center items-center mb-4 nav-date-controller">
  <div class="flex items-center gap-4">
    <!-- 前日へ -->
    <div class="tooltip">
      <%= link_to root_path(date: (@selected_date - 1.day).to_s), class: "text-gray-600 hover:text-gray-800" do %>
        <i class="fa-solid fa-chevron-left text-lg"></i>
        <span class="tooltip-text">前日へ</span>
      <% end %>
    </div>

    <!-- 日付表示 -->
    <span class="text-lg font-semibold text-gray-800">
      <%= @selected_date.strftime("%Y年%m月%d日") %> の記録
    </span>

    <!-- 翌日へ（本日より未来の場合は非表示） -->
    <div class="tooltip">
      <% if @selected_date < Date.current %>
        <%= link_to root_path(date: (@selected_date + 1.day).to_s), class: "text-gray-600 hover:text-gray-800" do %>
          <i class="fa-solid fa-chevron-right text-lg"></i>
          <span class="tooltip-text">翌日へ</span>
        <% end %>
      <% end %>
    </div>

    <!-- 📅 カレンダー選択 -->
    <div class="relative calendar-responsive">
      <!-- 隠しinput -->
      <input type="date" id="calendar-input"
        class="absolute opacity-0 pointer-events-none"
        value="<%= @selected_date %>"
        max="<%= Date.current %>">

      <!-- ボタン（クリックでinputを呼び出す） -->
      <button
        id="calendar-button"
        class="ml-2 px-3 py-1.5 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-200 transition duration-200 flex items-center gap-1">
        <i class="fa-solid fa-calendar-days"></i> 日付選択
      </button>

      <!-- 🟢 本日へ（過去・未来の日付時のみ表示） -->
      <% if @selected_date != Date.current %>
        <%= link_to "本日へ", root_path,
          class: "ml-4 px-3 py-1.5 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-200 transition duration-200 no-underline hover:no-underline" %>
      <% end %>
    </div>
  </div>
</div>

<%# 育児記録一覧部分を置き換え %>
<%= render partial: "home/records_table_or_empty", locals: { records: @records, selected_date: @selected_date } %>

<%# ----- 成長記録(グラフ) ----- %>
<h2 class="dashboard-title">成長グラフ(身長・体重統合)</h2>

<% if @growths_for_chart.present? && @growths_for_chart.any? %>
  <canvas id="dashboardChart" data-growths='<%= raw @growths_for_chart.to_json %>'></canvas>
<% else %>
  <p class="no-record-card">グラフはまだありません</p>
<% end %>