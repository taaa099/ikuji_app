<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Ikuji App" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "top", "child", "records", "schedule", "dashboard", "growth", "sleep_analysis", "diary", "user_settings/profile", "user_settings/darkmode", "modals", "notification", "tips", "swich_child_page", "device", "responsive", "error", "data-turbo-track": "reload" %>
    <% if user_signed_in? && current_child.present? %>
      <%= stylesheet_link_tag "sidebar", "data-turbo-track": "reload" %>
    <% end %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>
    <%= javascript_importmap_tags %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
  </head>
  <body data-current-child-id="<%= @current_child&.id || 0 %>" class="bg-white text-black dark:bg-gray-900 dark:text-gray-100">
    <header class="site-header">
      <% if user_signed_in? %>
        <div class="header-container flex justify-between items-center">
          <div class="flex items-center gap-4">
            <!-- Â∑¶Á´Ø„Éè„É≥„Éê„Éº„Ç¨„Éº„Éú„Çø„É≥ -->
            <% if @current_child.present? %>
              <div class="tooltip">
                <button id="sidebar-toggle" class="p-3 focus:outline-none bg-transparent border-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                </button>
                <span class="tooltip-text">„É°„Éã„É•„Éº„ÇíÈñã„Åè/Èñâ„Åò„Çã</span>
              </div>
            <% end %>
          </div>

          <!-- üåü ‰∏≠Â§ÆË°®Á§∫ÈÉ®ÂàÜ -->
          <% if @current_child.present? %>
            <% name = @current_child.name %>
            <% birth_date = @current_child.birth_date %>
            <% if birth_date %>
              <% age_in_days = (Date.today - birth_date).to_i %>
              <% if age_in_days < 0 %>
                <% months = 0 %>
                <% days = 0 %>
              <% else %>
                <% months = age_in_days / 30 %>
                <% days = age_in_days % 30 %>
              <% end %>
            <% else %>
              <% months = 0 %>
              <% days = 0 %>
            <% end %>
       
            <div class="header-center-item absolute left-1/2 transform -translate-x-1/2 text-center leading-tight">
              <div class="flex items-center justify-center gap-2 text-sm sm:text-base font-semibold text-gray-700 dark:text-gray-300">
                <% if @current_child.image.attached? %>
                  <%= image_tag @current_child.image.variant(resize_to_fill: [25, 25]), class: "rounded-full object-cover" %>
                <% end %>
                <div>
                  <%= name %>
                  <%= @current_child.gender == "Áî∑" ? '<i class="fa-solid fa-mars text-blue-500"></i>'.html_safe : '<i class="fa-solid fa-venus text-pink-500"></i>'.html_safe %>
                  <%= "#{months}„É∂Êúà#{days}Êó•" %>
                </div>
              </div>
              <div class="text-lg sm:text-2xl font-bold text-gray-900 dark:text-gray-100">
                <%= Time.current.strftime("%Y/%m/%d(#{%w(Êó• Êúà ÁÅ´ Ê∞¥ Êú® Èáë Âúü)[Time.current.wday]})") %>
              </div>
            </div>
          <% end %>

          <!-- Âè≥Á´Ø„Ç¢„ÇØ„Ç∑„Éß„É≥Áæ§ -->
          <div class="header-actions flex items-center gap-4">
            <% if @current_child.present? %>
              <!-- ‰ΩúÊàê„Éú„Çø„É≥ -->
              <div class="relative">
                <button id="new-record-button" class="gap-2">
                  <i class="fa fa-plus"></i>
                  ‰ΩúÊàê
                </button>

                <!-- „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ -->
                <div id="record-icons" class="absolute right-0 mt-2 hidden bg-white border rounded shadow-md w-48 z-50 flex flex-col gap-2 p-2">
                  <%= link_to new_child_feed_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-person-breastfeeding text-gray-600 text-xl"></i> Êéà‰π≥
                  <% end %>
                  <%= link_to new_child_diaper_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-baby text-gray-600 text-xl"></i> „Åä„ÇÄ„Å§
                  <% end %>
                  <%= link_to new_child_bottle_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-bottle-droplet text-gray-600 text-xl"></i> „Éü„É´„ÇØ
                  <% end %>
                  <%= link_to new_child_hydration_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-bottle-water text-gray-600 text-xl"></i> Ê∞¥ÂàÜË£úÁµ¶
                  <% end %>
                  <%= link_to new_child_baby_food_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-utensils text-gray-600 text-xl"></i> Èõ¢‰π≥È£ü
                  <% end %>
                  <%= link_to new_child_sleep_record_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-moon text-gray-600 text-xl"></i> Áù°Áú†
                  <% end %>
                  <%= link_to new_child_bath_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-bath text-gray-600 text-xl"></i> „ÅäÈ¢®ÂëÇ
                  <% end %>
                  <%= link_to new_child_temperature_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-temperature-three-quarters text-gray-600 text-xl"></i> ‰ΩìÊ∏©
                  <% end %>
                  <%= link_to new_child_vaccination_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-syringe text-gray-600 text-xl"></i> ‰∫àÈò≤Êé•Á®Æ
                  <% end %>

                  <!-- Âå∫Âàá„ÇäÁ∑ö -->
                  <hr class="menu-divider">

                  <%= link_to new_schedule_path, data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-calendar text-gray-600 text-xl"></i> „Çπ„Ç±„Ç∏„É•„Éº„É´  
                  <% end %>

                  <!-- Âå∫Âàá„ÇäÁ∑ö -->
                  <hr class="menu-divider">

                  <%= link_to new_child_growth_path(current_child), data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-hands-holding-child text-gray-600 text-xl"></i> ÊàêÈï∑Ë®òÈå≤
                  <% end %>

                  <!-- Âå∫Âàá„ÇäÁ∑ö -->
                  <hr class="menu-divider">

                  <%= link_to new_diary_path, data: { turbo_frame: "modal" }, class: "px-2 py-1 hover:bg-gray-100 rounded" do %>
                    <i class="fa-solid fa-book text-gray-600 text-xl"></i> Êó•Ë®ò
                  <% end %>
                </div>          
              </div>

              <!-- ÈÄöÁü•„Éô„É´ -->
              <div class="notification">
                <a href="javascript:void(0);" class="notification-link tooltip" id="notification-bell" data-mark-all-as-read-url="<%= mark_all_as_read_notifications_path %>">
                  <i class="fa fa-bell"></i>
                  <span class="tooltip-text">ÈÄöÁü•</span>
                  <% unread_count = current_child.notifications.where(read: false).count %>
                  <% if unread_count > 0 %>
                    <span class="notification-count"><%= unread_count %></span>
                  <% end %>
                </a>

                <!-- „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Áî®Êû† -->
                <div class="notification-dropdown hidden" id="notification-dropdown">
                  <div class="notification-dropdown-header">
                    ÈÄöÁü•
                  </div>
                  <%= render "notifications/index", notifications: current_child.notifications.order(delivered_at: :desc) %>
                </div>
              </div>
            <% else %>
              <!-- Â≠ê‰æõÊú™ÈÅ∏ÊäûÊôÇ„ÅØÈÄöÁü•„Éô„É´„ÇÇ‰ΩúÊàê„Éú„Çø„É≥„ÇÇË°®Á§∫„Åõ„Åö„Ç¢„Ç´„Ç¶„É≥„Éà„ÅÆ„Åø -->
            <% end %>

            <!-- „Ç¢„Ç´„Ç¶„É≥„Éà„Ç¢„Ç§„Ç≥„É≥ -->
            <div class="account relative tooltip">
             <button id="account-toggle" class="flex items-center bg-transparent border-none p-0 focus:outline-none cursor-pointer">
                <% if current_user.avatar.attached? %>
                  <%= image_tag url_for(current_user.avatar), class: "rounded-full w-12 h-12" %>
                <% else %>
                 <svg class="bg-gray-200 rounded-full w-12 h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="gray">
                    <circle cx="12" cy="8" r="4"/>
                    <path d="M12 14c-4 0-6 2-6 4v2h12v-2c0-2-2-4-6-4z"/>
                  </svg>
               <% end %>
             </button>
             <span class="tooltip-text">„Ç¢„Ç´„Ç¶„É≥„Éà</span>

              <!-- „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„É°„Éã„É•„Éº -->
              <div id="account-menu" class="absolute right-0 hidden bg-white shadow-md rounded mt-2 w-40 z-50">
                <%= link_to "„Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆö", user_account_path, class: "block px-4 py-2 hover:bg-gray-100" %>
                <%= link_to "Â≠ê‰æõ„ÇíÂàá„ÇäÊõø„Åà„Çã", switch_page_children_path, class: "block px-4 py-2 hover:bg-gray-100" %>

                <!-- Âå∫Âàá„ÇäÁ∑ö -->
                <hr class="menu-divider">

                <!-- „Éá„Ç∂„Ç§„É≥„ÉÜ„Éº„Éû„Éú„Çø„É≥ -->
                <div class="relative inline-block ml-4">
                  <%= link_to "#", id: "theme-toggle", class: "px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200" do %>
                    „Éá„Ç∂„Ç§„É≥„ÉÜ„Éº„Éû 
                  <% end %>

                  <div id="theme-menu" class="absolute left-0 mt-1 hidden bg-white border rounded shadow-md w-36 z-50">
                    <a href="#" data-theme="light" class="flex items-center w-full text-left px-4 py-2 hover:bg-gray-100">
                      <input type="checkbox" class="mr-2" id="theme-light">
                      „É©„Ç§„Éà„É¢„Éº„Éâ
                    </a>

                    <a href="#" data-theme="dark" class="flex items-center w-full text-left px-4 py-2 hover:bg-gray-100">
                      <input type="checkbox" class="mr-2" id="theme-dark">
                      „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ
                    </a>
                  </div>
                </div>

                <!-- Âå∫Âàá„ÇäÁ∑ö -->
                <hr class="menu-divider">

                <%= link_to "„É≠„Ç∞„Ç¢„Ç¶„Éà", destroy_user_session_path, method: :delete, class: "block px-4 py-2 hover:bg-gray-100" %>
              </div>
            </div>
          </div>
        </div>
      <% else %>
        <!-- „É≠„Ç∞„Ç§„É≥Ââç -->
        <div class="header-container--guest flex justify-between items-center">
          <div class="header-logo">
            <%= link_to "IkujiApp", root_path, class: "logo-text" %>
          </div>
          <!-- Âè≥Á´Ø„É≠„Ç∞„Ç§„É≥„ÉªÊñ∞Ë¶èÁôªÈå≤ -->
          <div class="header-actions flex items-center gap-4">
            <%= link_to "„É≠„Ç∞„Ç§„É≥", new_user_session_path, class: "btn-guest-action" %>
            <%= link_to "Êñ∞Ë¶èÁôªÈå≤", new_user_registration_path, class: "btn-guest-action" %>
          </div>
        </div>
      <% end %>

      <!-- „Éï„É©„ÉÉ„Ç∑„É•Ë°®Á§∫Áî® -->
      <div id="flash-messages">
        <%= render "shared/flash" %>
      </div>
    </header>

    <!-- Â∑¶Á´Ø„É≠„Ç¥ -->
    <% if user_signed_in? && current_child.present? %>
      <div class="header-logo">
        <%= link_to root_path do %>
          <%= image_tag "myapp_logo1.jpg", alt: "IkujiApp Logo", class: "logo-image" %>
        <% end %>
      </div>
    <% else %>
      <div class="header-logo--guest">
        <%= link_to root_path do %>
          <%= image_tag "myapp_logo1.jpg", alt: "IkujiApp Logo", class: "logo-image" %>
        <% end %>
      </div>
    <% end %>

    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <% if user_signed_in? && current_child.present? %>
      <div class="sidebar-overlay" id="sidebar-overlay"></div>
      <%= render "layouts/sidebar" %>
    <% end %>

    <!-- „É¢„Éº„ÉÄ„É´Êû† -->
    <turbo-frame id="modal"></turbo-frame>

    <!-- ÈÄöÂ∏∏„Éö„Éº„Ç∏„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="main-content">
      <%= yield %>
    </main>

    <!-- „Éï„ÉÉ„Çø„Éº -->
   <footer class="<%= (user_signed_in? && current_child.present?) ? 'logged-in' : 'guest' %> site-footer">
      <div class="footer-inner">

        <!-- ‰∏äÊÆµ: Âà©Áî®Ë¶èÁ¥Ñ„Éª„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº -->
        <div class="footer-links">
          <a href="/terms">Âà©Áî®Ë¶èÁ¥Ñ</a>
          <a href="/privacy">„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</a>
        </div>

        <!-- ‰∏ãÊÆµ: „Ç≥„Éî„Éº„É©„Ç§„ÉàÔºãSNS„É™„É≥„ÇØ -->
        <div class="footer-bottom">
          <p>¬© 2025 Ikuji App</p>
          <div class="footer-sns">
            <a href="https://github.com/taaa099/ikuji_app" target="_blank">
              <i class="fab fa-github"></i>
            </a>
            <a href="https://x.com/taaa_099" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </div>
        </div>
      </div>
    </footer>

    <!-- ÈÄöÁü•Áî®„Ç≥„É≥„ÉÜ„Éä -->
    <div id="notification-container"></div>

    <!-- Â∑¶Á´Ø„É≠„Ç¥(„Çπ„Éû„ÉõË°®Á§∫Áî®) -->
    <% if user_signed_in? && current_child.present? %>
      <div class="mobile-header-logo">
        <%= link_to root_path do %>
          <%= image_tag "icononly.jpg", alt: "IkujiApp Logo", class: "mobile-logo-image" %>
        <% end %>
      </div>
    <% else %>
      <div class="mobile-header-logo--guest">
        <%= link_to root_path do %>
          <%= image_tag "icononly.jpg", alt: "IkujiApp Logo", class: "mobile-logo-image" %>
        <% end %>
      </div>
    <% end %>

    <!--ÁîªÈù¢‰∏ã„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥(„Çπ„Éû„ÉõË°®Á§∫Áî®) -->
    <% if user_signed_in? && current_child.present? %>
      <nav class="mobile-bottom-nav">
        <%= link_to root_path, class: "mobile-nav-item" do %>
        <i class="fa-solid fa-chess-board text-gray-600 text-xl"></i>„Éõ„Éº„É†
        <% end %>

        <!-- Ë®òÈå≤‰∏ÄË¶ßÔºà„É¢„Éº„ÉÄ„É´Ëµ∑ÂãïÔºâ -->
        <a href="#" class="mobile-nav-item open-mobile-modal" data-mode="list">
          <i class="fa-solid fa-record-vinyl text-gray-600 text-xl"></i>Ë®òÈå≤‰∏ÄË¶ß
        </a>

        <!-- ‰ΩúÊàêÔºà„É¢„Éº„ÉÄ„É´Ëµ∑ÂãïÔºâ -->
        <a href="#" class="mobile-nav-item mobile-nav-create open-mobile-modal" data-mode="create">
          <i class="fa-solid fa-plus"></i>
        </a>

        <%= link_to schedules_path, class: "mobile-nav-item" do %>
          <i class="fa-solid fa-calendar text-gray-600 text-xl"></i>„Çπ„Ç±„Ç∏„É•„Éº„É´
        <% end %>

        <%= link_to root_path, class: "mobile-nav-item" do %>
          <i class="fa-solid fa-bars"></i>„É°„Éã„É•„Éº
        <% end %>
      </nav>
    <% end %>

    <!-- „ÄåË®òÈå≤‰∏ÄË¶ß„Äç„ÄåÔºã„Äç„ÅÆ„É¢„Éº„ÉÄ„É´ -->
    <%= render "layouts/mobile_modal" %>
  </body>
</html>